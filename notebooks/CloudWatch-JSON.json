{"paragraphs":[{"title":"Export CloudTrail Events and Save Locally","text":"%pyspark\nimport boto3\nfrom json import dumps, loads\n\nsession = boto3.session.Session(region_name='eu-west-1')\nct = session.client('cloudtrail')\nevents_json = ct.lookup_events(MaxResults=200)[\"Events\"]\nwith open(\"/tmp/events.json\",\"w\") as fh:\n    fh.write(dumps(events_json, default=str))\n\nevents_cloudwatch_json = []\nfor i, c in enumerate(events_json):\n    events_cloudwatch_json.append(loads(events_json[i][\"CloudTrailEvent\"]))\n    \nwith open(\"/tmp/events_cloudtrail.json\",\"w\") as fh:\n    fh.write(dumps(events_cloudwatch_json, default=str))","user":"anonymous","dateUpdated":"2017-11-06T16:38:57+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1509818527472_2016543289","id":"20171104-180207_933241682","dateCreated":"2017-11-04T18:02:07+0000","dateStarted":"2017-11-06T16:38:57+0000","dateFinished":"2017-11-06T16:38:57+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:28"},{"title":"Create DataFrames of JSON Events","text":"%spark\nval df = sqlContext.read.json(\"/tmp/events.json\")\nval ct = sqlContext.read.json(\"/tmp/events_cloudtrail.json\")","user":"anonymous","dateUpdated":"2017-11-06T16:39:00+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\ndf: org.apache.spark.sql.DataFrame = [CloudTrailEvent: string, EventId: string ... 4 more fields]\n\nct: org.apache.spark.sql.DataFrame = [additionalEventData: struct<LoginTo: string, MFAUsed: string ... 1 more field>, awsRegion: string ... 13 more fields]\n"}]},"apps":[],"jobName":"paragraph_1509818624624_2083828374","id":"20171104-180344_847106942","dateCreated":"2017-11-04T18:03:44+0000","dateStarted":"2017-11-06T16:39:00+0000","dateFinished":"2017-11-06T16:39:00+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:29"},{"title":"Show Schemas","text":"%spark\ndf.printSchema()\nct.printSchema()\ndf.createOrReplaceTempView(\"cloudtrail\")\nct.createOrReplaceTempView(\"cloudtrail_events\")","user":"anonymous","dateUpdated":"2017-11-06T16:39:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- CloudTrailEvent: string (nullable = true)\n |-- EventId: string (nullable = true)\n |-- EventName: string (nullable = true)\n |-- EventTime: string (nullable = true)\n |-- Resources: array (nullable = true)\n |    |-- element: struct (containsNull = true)\n |    |    |-- ResourceName: string (nullable = true)\n |    |    |-- ResourceType: string (nullable = true)\n |-- Username: string (nullable = true)\n\nroot\n |-- additionalEventData: struct (nullable = true)\n |    |-- LoginTo: string (nullable = true)\n |    |-- MFAUsed: string (nullable = true)\n |    |-- MobileVersion: string (nullable = true)\n |-- awsRegion: string (nullable = true)\n |-- eventID: string (nullable = true)\n |-- eventName: string (nullable = true)\n |-- eventSource: string (nullable = true)\n |-- eventTime: string (nullable = true)\n |-- eventType: string (nullable = true)\n |-- eventVersion: string (nullable = true)\n |-- recipientAccountId: string (nullable = true)\n |-- requestID: string (nullable = true)\n |-- requestParameters: struct (nullable = true)\n |    |-- groupId: string (nullable = true)\n |    |-- ipPermissions: struct (nullable = true)\n |    |    |-- items: array (nullable = true)\n |    |    |    |-- element: struct (containsNull = true)\n |    |    |    |    |-- fromPort: long (nullable = true)\n |    |    |    |    |-- ipProtocol: string (nullable = true)\n |    |    |    |    |-- ipRanges: struct (nullable = true)\n |    |    |    |    |    |-- items: array (nullable = true)\n |    |    |    |    |    |    |-- element: struct (containsNull = true)\n |    |    |    |    |    |    |    |-- cidrIp: string (nullable = true)\n |    |    |    |    |-- toPort: long (nullable = true)\n |    |-- policyArn: string (nullable = true)\n |    |-- policyDocument: string (nullable = true)\n |    |-- policyName: string (nullable = true)\n |    |-- roleName: string (nullable = true)\n |    |-- setAsDefault: boolean (nullable = true)\n |-- responseElements: struct (nullable = true)\n |    |-- ConsoleLogin: string (nullable = true)\n |    |-- _return: boolean (nullable = true)\n |    |-- policyVersion: struct (nullable = true)\n |    |    |-- createDate: string (nullable = true)\n |    |    |-- isDefaultVersion: boolean (nullable = true)\n |    |    |-- versionId: string (nullable = true)\n |-- sourceIPAddress: string (nullable = true)\n |-- userAgent: string (nullable = true)\n |-- userIdentity: struct (nullable = true)\n |    |-- accessKeyId: string (nullable = true)\n |    |-- accountId: string (nullable = true)\n |    |-- arn: string (nullable = true)\n |    |-- principalId: string (nullable = true)\n |    |-- sessionContext: struct (nullable = true)\n |    |    |-- attributes: struct (nullable = true)\n |    |    |    |-- creationDate: string (nullable = true)\n |    |    |    |-- mfaAuthenticated: string (nullable = true)\n |    |-- type: string (nullable = true)\n |    |-- userName: string (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1509818981728_-906382070","id":"20171104-180941_645179688","dateCreated":"2017-11-04T18:09:41+0000","dateStarted":"2017-11-06T16:39:02+0000","dateFinished":"2017-11-06T16:39:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:30"},{"title":"Count CloudTrail Event Names","text":"%sql\nSELECT EventName, count(EventName) as Count FROM cloudtrail GROUP BY EventName","user":"anonymous","dateUpdated":"2017-11-06T16:39:04+0000","config":{"colWidth":6,"enabled":true,"results":{"0":{"graph":{"mode":"table","height":216,"optionOpen":false},"helium":{}}},"editorSetting":{"language":"sql","editOnDblClick":false},"editorMode":"ace/mode/sql","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"ERROR","msg":[{"type":"TEXT","data":"java.io.FileNotFoundException: /tmp/blockmgr-315918ce-8da0-40b0-9e6c-6bfff759bf27/38/temp_shuffle_b8c3f9a1-9fd1-46cf-9f49-97e615c8c03c (No such file or directory)\n\tat java.io.FileOutputStream.open0(Native Method)\n\tat java.io.FileOutputStream.open(FileOutputStream.java:270)\n\tat java.io.FileOutputStream.<init>(FileOutputStream.java:213)\n\tat org.apache.spark.storage.DiskBlockObjectWriter.initialize(DiskBlockObjectWriter.scala:102)\n\tat org.apache.spark.storage.DiskBlockObjectWriter.open(DiskBlockObjectWriter.scala:115)\n\tat org.apache.spark.storage.DiskBlockObjectWriter.write(DiskBlockObjectWriter.scala:229)\n\tat org.apache.spark.shuffle.sort.BypassMergeSortShuffleWriter.write(BypassMergeSortShuffleWriter.java:152)\n\tat org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:96)\n\tat org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:53)\n\tat org.apache.spark.scheduler.Task.run(Task.scala:99)\n\tat org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:282)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:748)\n"}]},"apps":[],"jobName":"paragraph_1509832028015_-1738670938","id":"20171104-214708_664583839","dateCreated":"2017-11-04T21:47:08+0000","dateStarted":"2017-11-06T16:39:04+0000","dateFinished":"2017-11-06T16:39:04+0000","status":"ERROR","progressUpdateIntervalMs":500,"$$hashKey":"object:31"},{"title":"Display CloudTrail Resource Names","text":"%sql\nSELECT EventName, EventTime, CONCAT_WS(', ', Resources.ResourceName) AS Resource, Username FROM cloudtrail ORDER BY EventTime DESC","user":"anonymous","dateUpdated":"2017-11-06T16:39:06+0000","config":{"colWidth":6,"enabled":true,"results":{},"editorSetting":{"language":"sql","editOnDblClick":false},"editorMode":"ace/mode/sql","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"EventName\tEventTime\tResource\tUsername\nConsoleLogin\t2017-11-06 13:26:07+00:00\t\troot\nRevokeSecurityGroupIngress\t2017-11-05 14:46:30+00:00\tsg-44994a21\troot\nAuthorizeSecurityGroupIngress\t2017-11-05 14:45:27+00:00\tsg-75b8670d\troot\nRevokeSecurityGroupIngress\t2017-11-05 12:45:28+00:00\tsg-44994a21\troot\nConsoleLogin\t2017-11-05 12:38:33+00:00\t\troot\nPutRolePolicy\t2017-11-04 17:23:22+00:00\tWebStack-cf, aws-stack-IAMRole-1FZR9PWYCSGLC\troot\nPutRolePolicy\t2017-11-04 15:30:53+00:00\tWebStack-cf, aws-stack-IAMRole-1FZR9PWYCSGLC\troot\nConsoleLogin\t2017-11-04 14:52:58+00:00\t\troot\nAuthorizeSecurityGroupIngress\t2017-11-04 11:56:27+00:00\tsg-75b8670d\troot\nRevokeSecurityGroupIngress\t2017-11-04 11:56:27+00:00\tsg-75b8670d\troot\nCreatePolicyVersion\t2017-11-04 00:56:39+00:00\tarn:aws:iam::175308653158:policy/service-role/kinesis-analytics-service-es-test-analytics-eu-west-1\troot\nConsoleLogin\t2017-11-04 00:35:27+00:00\t\troot\nConsoleLogin\t2017-11-03 01:50:20+00:00\t\troot\nConsoleLogin\t2017-11-01 18:42:16+00:00\t\troot\nConsoleLogin\t2017-11-01 00:31:19+00:00\t\troot\n"}]},"apps":[],"jobName":"paragraph_1509832599366_-912771581","id":"20171104-215639_997063013","dateCreated":"2017-11-04T21:56:39+0000","dateStarted":"2017-11-06T16:39:06+0000","dateFinished":"2017-11-06T16:39:06+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:32"},{"title":"Display CloudTrail Events","text":"%sql\nSELECT awsRegion, eventTime, eventName, eventType, explode(requestParameters.ipPermissions.items), eventSource, sourceIPAddress, userIdentity.userName, requestParameters.policyName FROM cloudtrail_events ORDER BY eventTime DESC","user":"anonymous","dateUpdated":"2017-11-06T16:39:09+0000","config":{"colWidth":12,"enabled":true,"results":{"0":{"graph":{"mode":"table","height":300,"optionOpen":false},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false},"helium":{}}},"editorSetting":{"language":"sql","editOnDblClick":false},"editorMode":"ace/mode/sql","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"awsRegion\teventTime\teventName\teventType\tcol\teventSource\tsourceIPAddress\tuserName\tpolicyName\neu-west-1\t2017-11-05T14:46:30Z\tRevokeSecurityGroupIngress\tAwsApiCall\t[443,tcp,[WrappedArray([0.0.0.0/0])],443]\tec2.amazonaws.com\t86.187.165.9\tsaidsef\tnull\neu-west-1\t2017-11-05T14:45:27Z\tAuthorizeSecurityGroupIngress\tAwsApiCall\t[-1,icmp,[WrappedArray([86.187.165.9/32])],-1]\tec2.amazonaws.com\t86.187.165.9\tsaidsef\tnull\neu-west-1\t2017-11-05T12:45:28Z\tRevokeSecurityGroupIngress\tAwsApiCall\t[8443,tcp,[WrappedArray([54.240.197.0/24])],8443]\tec2.amazonaws.com\t86.187.165.9\tsaidsef\tnull\neu-west-1\t2017-11-05T12:45:28Z\tRevokeSecurityGroupIngress\tAwsApiCall\t[8443,tcp,[WrappedArray([54.239.99.0/24])],8443]\tec2.amazonaws.com\t86.187.165.9\tsaidsef\tnull\neu-west-1\t2017-11-05T12:45:28Z\tRevokeSecurityGroupIngress\tAwsApiCall\t[8443,tcp,[WrappedArray([87.238.80.64/29])],8443]\tec2.amazonaws.com\t86.187.165.9\tsaidsef\tnull\neu-west-1\t2017-11-05T12:45:28Z\tRevokeSecurityGroupIngress\tAwsApiCall\t[8443,tcp,[WrappedArray([87.238.84.64/29])],8443]\tec2.amazonaws.com\t86.187.165.9\tsaidsef\tnull\neu-west-1\t2017-11-04T11:56:27Z\tAuthorizeSecurityGroupIngress\tAwsApiCall\t[null,-1,[WrappedArray([86.187.165.9/32])],null]\tec2.amazonaws.com\t86.187.165.9\tsaidsef\tnull\neu-west-1\t2017-11-04T11:56:27Z\tRevokeSecurityGroupIngress\tAwsApiCall\t[null,-1,[WrappedArray([0.0.0.0/0])],null]\tec2.amazonaws.com\t86.187.165.9\tsaidsef\tnull\n"}]},"apps":[],"jobName":"paragraph_1509832046622_-1635542909","id":"20171104-214726_1112687887","dateCreated":"2017-11-04T21:47:26+0000","dateStarted":"2017-11-06T16:39:09+0000","dateFinished":"2017-11-06T16:39:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:33"},{"text":"%sql\n","user":"said","dateUpdated":"2017-11-06T13:51:29+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"sql"},"editorMode":"ace/mode/sql","editorHide":false,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509891115851_259570591","id":"20171105-141155_1404622732","dateCreated":"2017-11-05T14:11:55+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:34"}],"name":"CloudWatch-JSON","id":"2CZS8SXJ4","angularObjects":{"2CQK63JJR:shared_process":[],"2CRCDZV8M:shared_process":[],"2CQUPP6M8:shared_process":[],"2CTP566CZ:shared_process":[],"2CTK9P9G2:shared_process":[],"2CQX3E1Q4:shared_process":[],"2CQ3SES16:shared_process":[],"2CRCA2596:shared_process":[],"2CT6DSC85:shared_process":[],"2CSRGT77M:shared_process":[],"2CSKAH3EP:shared_process":[],"2CRY3C5ST:shared_process":[],"2CRSV47JV:shared_process":[],"2CQAFQG3F:shared_process":[],"2CRJ734X5:shared_process":[],"2CT3F4DMK:shared_process":[],"2CQDQDCV9:shared_process":[],"2CQ68S2G1:shared_process":[],"2CQS4HJCC:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false","cronExecutingUser":"said","cron":"0 0/30 * * * ?"},"info":{},"checkpoint":{"message":"v1"}}