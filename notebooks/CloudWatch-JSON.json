{"paragraphs":[{"title":"Export CloudTrail Events and Save Locally","text":"%pyspark\nimport boto3\nfrom json import dumps, loads\n\nsession = boto3.session.Session(region_name='eu-west-1')\nct = session.client('cloudtrail')\nevents_json = ct.lookup_events(MaxResults=200)[\"Events\"]\nwith open(\"/tmp/events.json\",\"w\") as fh:\n    fh.write(dumps(events_json, default=str))\n\nevents_cloudwatch_json = []\nfor i, c in enumerate(events_json):\n    events_cloudwatch_json.append(loads(events_json[i][\"CloudTrailEvent\"]))\n    \nwith open(\"/tmp/events_cloudtrail.json\",\"w\") as fh:\n    fh.write(dumps(events_cloudwatch_json, default=str))","user":"said","dateUpdated":"2017-11-06T16:38:57+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509818527472_2016543289","id":"20171104-180207_933241682","dateCreated":"2017-11-04T18:02:07+0000","dateStarted":"2017-11-06T18:00:00+0000","dateFinished":"2017-11-06T18:00:00+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:992"},{"title":"Create DataFrames of JSON Events","text":"%spark\nval df = sqlContext.read.json(\"/tmp/events.json\")\nval ct = sqlContext.read.json(\"/tmp/events_cloudtrail.json\")","user":"said","dateUpdated":"2017-11-06T16:39:00+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509818624624_2083828374","id":"20171104-180344_847106942","dateCreated":"2017-11-04T18:03:44+0000","dateStarted":"2017-11-06T18:00:00+0000","dateFinished":"2017-11-06T18:00:02+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:993"},{"title":"Show Schemas","text":"%spark\ndf.printSchema()\nct.printSchema()\ndf.createOrReplaceTempView(\"cloudtrail\")\nct.createOrReplaceTempView(\"cloudtrail_events\")","user":"said","dateUpdated":"2017-11-06T16:39:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509818981728_-906382070","id":"20171104-180941_645179688","dateCreated":"2017-11-04T18:09:41+0000","dateStarted":"2017-11-06T18:00:00+0000","dateFinished":"2017-11-06T18:00:06+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:994"},{"title":"Count CloudTrail Event Names","text":"%sql\nSELECT EventName, count(EventName) as Count FROM cloudtrail GROUP BY EventName","user":"said","dateUpdated":"2017-11-06T16:39:04+0000","config":{"colWidth":6,"enabled":true,"results":{"0":{"graph":{"mode":"table","height":216,"optionOpen":false},"helium":{}}},"editorSetting":{"language":"sql","editOnDblClick":false},"editorMode":"ace/mode/sql","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509832028015_-1738670938","id":"20171104-214708_664583839","dateCreated":"2017-11-04T21:47:08+0000","dateStarted":"2017-11-06T18:00:03+0000","dateFinished":"2017-11-06T18:00:08+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:995"},{"title":"Display CloudTrail Resource Names","text":"%sql\nSELECT EventName, EventTime, CONCAT_WS(', ', Resources.ResourceName) AS Resource, Username FROM cloudtrail ORDER BY EventTime DESC","user":"said","dateUpdated":"2017-11-06T16:39:06+0000","config":{"colWidth":6,"enabled":true,"results":{},"editorSetting":{"language":"sql","editOnDblClick":false},"editorMode":"ace/mode/sql","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509832599366_-912771581","id":"20171104-215639_997063013","dateCreated":"2017-11-04T21:56:39+0000","dateStarted":"2017-11-06T18:00:06+0000","dateFinished":"2017-11-06T18:00:09+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:996"},{"title":"Display CloudTrail Events","text":"%sql\nSELECT awsRegion, eventTime, eventName, eventType, explode(requestParameters.ipPermissions.items), eventSource, sourceIPAddress, userIdentity.userName, requestParameters.policyName FROM cloudtrail_events ORDER BY eventTime DESC","user":"said","dateUpdated":"2017-11-06T16:39:09+0000","config":{"colWidth":12,"enabled":true,"results":{"0":{"graph":{"mode":"table","height":300,"optionOpen":false},"helium":{}},"1":{"graph":{"mode":"table","height":300,"optionOpen":false},"helium":{}}},"editorSetting":{"language":"sql","editOnDblClick":false},"editorMode":"ace/mode/sql","editorHide":false,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509832046622_-1635542909","id":"20171104-214726_1112687887","dateCreated":"2017-11-04T21:47:26+0000","dateStarted":"2017-11-06T18:00:08+0000","dateFinished":"2017-11-06T18:00:10+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:997"},{"text":"%sql\n","user":"said","dateUpdated":"2017-11-06T16:33:20+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"sql"},"editorMode":"ace/mode/sql","editorHide":false,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1509891115851_259570591","id":"20171105-141155_1404622732","dateCreated":"2017-11-05T14:11:55+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:998"}],"name":"CloudWatch-JSON","id":"2CZS8SXJ4","angularObjects":{"2CQK63JJR:shared_process":[],"2CRCDZV8M:shared_process":[],"2CQUPP6M8:shared_process":[],"2CTP566CZ:shared_process":[],"2CTK9P9G2:shared_process":[],"2CQX3E1Q4:shared_process":[],"2CQ3SES16:shared_process":[],"2CRCA2596:shared_process":[],"2CT6DSC85:shared_process":[],"2CSRGT77M:shared_process":[],"2CSKAH3EP:shared_process":[],"2CRY3C5ST:shared_process":[],"2CRSV47JV:shared_process":[],"2CQAFQG3F:shared_process":[],"2CRJ734X5:shared_process":[],"2CT3F4DMK:shared_process":[],"2CQDQDCV9:shared_process":[],"2CQ68S2G1:shared_process":[],"2CQS4HJCC:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false","cronExecutingUser":"said","cron":"0 0/30 * * * ?"},"info":{}}